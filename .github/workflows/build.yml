name: Build and Deploy to Another Repo

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出当前仓库代码
      - name: Checkout current repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      # 2. 设置Node.js环境
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'
      
      # 3. 安装依赖
      - name: Install dependencies
        run: npm ci
      
      # 4. 构建项目
      - name: Build project
        run: npm run build
      
      # 5. 设置部署环境变量
      - name: Set deployment variables
        id: vars
        run: |
          # 设置默认值和环境变量
          echo "TARGET_REPO=${{ vars.TARGET_REPO }}" >> $GITHUB_OUTPUT
          echo "TARGET_BRANCH=${{ vars.TARGET_BRANCH }}" >> $GITHUB_OUTPUT
          echo "DEPLOY_SUBDIR=${{ vars.DEPLOY_SUBDIR }}" >> $GITHUB_OUTPUT
          echo "部署配置: 目标分支=${{ vars.TARGET_BRANCH }}, 子目录=${{ vars.DEPLOY_SUBDIR }}"
      
      # 6. 检出目标仓库
      - name: Checkout target repo
        uses: actions/checkout@v3
        with:
          repository: ${{ steps.vars.outputs.TARGET_REPO }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: target-repo
          fetch-depth: 0
          ref: ${{ steps.vars.outputs.TARGET_BRANCH }}
      
      # 7. 复制构建产物到目标仓库的指定子目录
      - name: Copy build artifacts
        run: |
          TARGET_DIR="target-repo/${{ steps.vars.outputs.DEPLOY_SUBDIR }}"
          echo "复制构建产物到: $TARGET_DIR"
          # 确保目标子目录存在
          mkdir -p "$TARGET_DIR"
          # 复制构建产物
          cp -r build/* "$TARGET_DIR"/
          echo "构建产物复制完成"
          # 显示复制的文件数量以验证
          echo "复制的文件数量: $(find "$TARGET_DIR" -type f | wc -l)"
      
      # 8. 提交并推送更改到目标仓库
      - name: Commit and push changes
        id: push
        run: |
          cd target-repo
          # 配置Git用户
          git config --local user.name 'GitHub Actions'
          git config --local user.email 'actions@github.com'
          
          # 检查是否有更改
          git add .
          if git diff --staged --quiet; then
            echo "没有检测到更改，跳过提交"
            echo "changes_made=false" >> $GITHUB_OUTPUT
          else
            # 提交更改
            COMMIT_MSG="Deploy from ${{ github.repository }} (${{ github.sha }}) on $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "提交信息: $COMMIT_MSG"
            git commit -m "$COMMIT_MSG"
            
            # 推送更改
            echo "推送到目标仓库分支: ${{ steps.vars.outputs.TARGET_BRANCH }}"
            git push origin HEAD:${{ steps.vars.outputs.TARGET_BRANCH }}
            echo "推送成功"
            echo "changes_made=true" >> $GITHUB_OUTPUT
          fi
      
      # 9. 部署状态通知
      - name: Deployment status
        if: always()
        run: |
          if [ "${{ steps.push.outputs.changes_made }}" = "true" ]; then
            echo "✅ 部署成功！构建产物已部署到 ${{ secrets.TARGET_REPO }}/${{ steps.vars.outputs.DEPLOY_SUBDIR }}"
          else
            echo "ℹ️ 没有检测到更改，部署已跳过"
          fi